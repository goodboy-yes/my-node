<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.29">
    <title>redux | Gkc's notes</title><meta name="description" content="Record knowledge">
    <link rel="modulepreload" href="/my-notes/assets/app.93ab8767.js"><link rel="modulepreload" href="/my-notes/assets/redux.html.de1110a9.js"><link rel="modulepreload" href="/my-notes/assets/plugin-vue_export-helper.21dcd24c.js"><link rel="modulepreload" href="/my-notes/assets/redux.html.63945342.js">
    <link rel="stylesheet" href="/my-notes/assets/style.4b916bd5.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header ref_key="navbar" class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/my-notes/" class=""><!----><span class="site-name can-hide">Gkc&#39;s notes</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><a class="nav-link external" href="https://v2.vuepress.vuejs.org/zh/" rel="noopener noreferrer" target="_blank" aria-label="VuePress"><!--[--><!--]--> VuePress <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/goodboy-yes/my-node" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><a class="nav-link external" href="https://v2.vuepress.vuejs.org/zh/" rel="noopener noreferrer" target="_blank" aria-label="VuePress"><!--[--><!--]--> VuePress <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/goodboy-yes/my-node" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><p class="sidebar-heading sidebar-item">HTML</p><ul class=""><li><!--[--><a href="/my-notes/html/sample-template.html" class="nav-link sidebar-item" aria-label="示例模板"><!--[--><!--]--> 示例模板 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/my-notes/html/knowledge-points.html" class="nav-link sidebar-item" aria-label="知识点"><!--[--><!--]--> 知识点 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">JS</p><ul class=""><li><!--[--><a href="/my-notes/js/knowledge-points.html" class="nav-link sidebar-item" aria-label="知识点"><!--[--><!--]--> 知识点 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/my-notes/js/handwriting-knowledge.html" class="nav-link sidebar-item" aria-label="手写知识点"><!--[--><!--]--> 手写知识点 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/my-notes/js/code-snippet.html" class="nav-link sidebar-item" aria-label="小技巧"><!--[--><!--]--> 小技巧 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/my-notes/js/bit-operation.html" class="nav-link sidebar-item" aria-label="位运算"><!--[--><!--]--> 位运算 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/my-notes/js/regular-expression.html" class="nav-link sidebar-item" aria-label="正则表达式"><!--[--><!--]--> 正则表达式 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/my-notes/js/file-operation.html" class="nav-link sidebar-item" aria-label="文件操作"><!--[--><!--]--> 文件操作 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/my-notes/js/cross-domain.html" class="nav-link sidebar-item" aria-label="跨域"><!--[--><!--]--> 跨域 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/my-notes/js/code-style.html" class="nav-link sidebar-item" aria-label="代码风格"><!--[--><!--]--> 代码风格 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/my-notes/js/performance-optimization.html" class="nav-link sidebar-item" aria-label="性能优化"><!--[--><!--]--> 性能优化 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/my-notes/js/design-pattern.html" class="nav-link sidebar-item" aria-label="设计模式"><!--[--><!--]--> 设计模式 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/my-notes/js/principle-analysis.html" class="nav-link sidebar-item" aria-label="原理分析"><!--[--><!--]--> 原理分析 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">TypeScript</p><ul class=""><li><!--[--><a href="/my-notes/ts/basic-knowledge.html" class="nav-link sidebar-item" aria-label="基础知识"><!--[--><!--]--> 基础知识 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/my-notes/ts/to-use.html" class="nav-link sidebar-item" aria-label="如何使用"><!--[--><!--]--> 如何使用 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">CSS</p><ul class=""><li><!--[--><a href="/my-notes/css/knowledge-points.html" class="nav-link sidebar-item" aria-label="知识点"><!--[--><!--]--> 知识点 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/my-notes/css/bfc.html" class="nav-link sidebar-item" aria-label="块级格式化上下文(BFC)"><!--[--><!--]--> 块级格式化上下文(BFC) <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/my-notes/css/pseudo-classes-and-elements.html" class="nav-link sidebar-item" aria-label="伪类和伪元素"><!--[--><!--]--> 伪类和伪元素 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/my-notes/css/aspect-ratio.html" class="nav-link sidebar-item" aria-label="aspect-ratio"><!--[--><!--]--> aspect-ratio <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/my-notes/css/skill.html" class="nav-link sidebar-item" aria-label="小技巧"><!--[--><!--]--> 小技巧 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/my-notes/css/compositing-layer.html" class="nav-link sidebar-item" aria-label="合成层"><!--[--><!--]--> 合成层 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">Vue2</p><ul class=""><li><!--[--><a href="/my-notes/vue2/knowledge-points.html" class="nav-link sidebar-item" aria-label="知识点"><!--[--><!--]--> 知识点 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/my-notes/vue2/keep-alive.html" class="nav-link sidebar-item" aria-label="keep-alive"><!--[--><!--]--> keep-alive <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">Vue3</p><ul class=""><li><!--[--><a href="/my-notes/vue3/difference-from-vue2.html" class="nav-link sidebar-item" aria-label="与 Vue2 不同点"><!--[--><!--]--> 与 Vue2 不同点 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/my-notes/vue3/vite.html" class="nav-link sidebar-item" aria-label="Vite"><!--[--><!--]--> Vite <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/my-notes/vue3/practice.html" class="nav-link sidebar-item" aria-label="实践"><!--[--><!--]--> 实践 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/my-notes/vue3/style-guide.html" class="nav-link sidebar-item" aria-label="风格指南"><!--[--><!--]--> 风格指南 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><a href="/my-notes/react" class="nav-link router-link-active sidebar-heading sidebar-item active" aria-label="React"><!--[--><!--]--> React <!--[--><!--]--></a><ul class=""><li><!--[--><a href="/my-notes/react/use.html" class="nav-link sidebar-item" aria-label="使用"><!--[--><!--]--> 使用 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/my-notes/react/api.html" class="nav-link sidebar-item" aria-label="API"><!--[--><!--]--> API <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/my-notes/react/react-router.html" class="nav-link sidebar-item" aria-label="react-router(V6)"><!--[--><!--]--> react-router(V6) <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/my-notes/react/umijs.html" class="nav-link sidebar-item" aria-label="umijs"><!--[--><!--]--> umijs <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/my-notes/react/code-standard.html" class="nav-link sidebar-item" aria-label="代码规范"><!--[--><!--]--> 代码规范 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/my-notes/react/redux.html" class="router-link-active router-link-exact-active nav-link router-link-active sidebar-item active" aria-label="redux"><!--[--><!--]--> redux <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/my-notes/react/redux.html#概念" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="概念"><!--[--><!--]--> 概念 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/my-notes/react/redux.html#state-管理" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="State 管理"><!--[--><!--]--> State 管理 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/my-notes/react/redux.html#术语" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="术语"><!--[--><!--]--> 术语 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/my-notes/react/redux.html#redux-三大原则" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="redux 三大原则"><!--[--><!--]--> redux 三大原则 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/my-notes/react/redux.html#redux-数据流" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Redux 数据流"><!--[--><!--]--> Redux 数据流 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/my-notes/react/redux.html#什么时候使用-redux" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="什么时候使用 redux"><!--[--><!--]--> 什么时候使用 redux <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/my-notes/react/redux.html#注意点" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="注意点"><!--[--><!--]--> 注意点 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/my-notes/react/redux.html#示例" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="示例"><!--[--><!--]--> 示例 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/my-notes/react/redux.html#redux-1" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="redux"><!--[--><!--]--> redux <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/my-notes/react/redux.html#redux-toolkit" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Redux Toolkit"><!--[--><!--]--> Redux Toolkit <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/my-notes/react/redux.html#使用" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="使用"><!--[--><!--]--> 使用 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/my-notes/react/redux.html#使用-useselector-提取数据" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="使用 useSelector 提取数据"><!--[--><!--]--> 使用 useSelector 提取数据 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/my-notes/react/redux.html#使用-usedispatch-来-dispatch-action" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="使用 useDispatch 来 dispatch action"><!--[--><!--]--> 使用 useDispatch 来 dispatch action <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/my-notes/react/redux.html#在-reducer-定义一个-prepare-函数" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="在 reducer 定义一个 prepare 函数"><!--[--><!--]--> 在 reducer 定义一个 prepare 函数 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/my-notes/react/redux.html#用-thunk-编写异步逻辑" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="用 Thunk 编写异步逻辑"><!--[--><!--]--> 用 Thunk 编写异步逻辑 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/my-notes/react/redux.html#记忆化的-selector-函数" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="记忆化的 Selector 函数"><!--[--><!--]--> 记忆化的 Selector 函数 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li></ul><!--]--></li><li><!--[--><a href="/my-notes/react/dva.html" class="nav-link sidebar-item" aria-label="dva"><!--[--><!--]--> dva <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/my-notes/react/ahooks.html" class="nav-link sidebar-item" aria-label="ahooks"><!--[--><!--]--> ahooks <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><a href="/my-notes/node-js" class="nav-link sidebar-heading sidebar-item" aria-label="Nodejs"><!--[--><!--]--> Nodejs <!--[--><!--]--></a><!----><!--]--><!--[--><p class="sidebar-heading sidebar-item">Git</p><ul class=""><li><!--[--><a href="/my-notes/git/basic-command.html" class="nav-link sidebar-item" aria-label="用法"><!--[--><!--]--> 用法 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/my-notes/git/commit-standard.html" class="nav-link sidebar-item" aria-label="commit 规范"><!--[--><!--]--> commit 规范 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/my-notes/git/reset-and-revert.html" class="nav-link sidebar-item" aria-label="git reset 和 git revert 的区别"><!--[--><!--]--> git reset 和 git revert 的区别 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/my-notes/git/commit-amend.html" class="nav-link sidebar-item" aria-label="git commit --amend"><!--[--><!--]--> git commit --amend <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">Webpack</p><ul class=""><li><!--[--><a href="/my-notes/webpack/principle-analysis.html" class="nav-link sidebar-item" aria-label="原理分析"><!--[--><!--]--> 原理分析 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">开发实践</p><ul class=""><li><!--[--><a href="/my-notes/development-practice/functional-programming.html" class="nav-link sidebar-item" aria-label="函数式编程"><!--[--><!--]--> 函数式编程 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/my-notes/development-practice/refactoring.html" class="nav-link sidebar-item" aria-label="重构"><!--[--><!--]--> 重构 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/my-notes/development-practice/interactive.html" class="nav-link sidebar-item" aria-label="交互设计"><!--[--><!--]--> 交互设计 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/my-notes/development-practice/technical-scheme.html" class="nav-link sidebar-item" aria-label="技术方案"><!--[--><!--]--> 技术方案 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">知识点</p><ul class=""><li><!--[--><a href="/my-notes/knowledge-point/algorithm.html" class="nav-link sidebar-item" aria-label="算法"><!--[--><!--]--> 算法 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/my-notes/knowledge-point/network.html" class="nav-link sidebar-item" aria-label="网络"><!--[--><!--]--> 网络 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><a href="/my-notes/development-proposals" class="nav-link sidebar-heading sidebar-item" aria-label="发展建议"><!--[--><!--]--> 发展建议 <!--[--><!--]--></a><!----><!--]--><!--[--><a href="/my-notes/vs-code" class="nav-link sidebar-heading sidebar-item" aria-label="VSCode"><!--[--><!--]--> VSCode <!--[--><!--]--></a><!----><!--]--><!--[--><a href="/my-notes/docker" class="nav-link sidebar-heading sidebar-item" aria-label="Docker"><!--[--><!--]--> Docker <!--[--><!--]--></a><!----><!--]--><!--[--><a href="/my-notes/collection" class="nav-link sidebar-heading sidebar-item" aria-label="收藏"><!--[--><!--]--> 收藏 <!--[--><!--]--></a><!----><!--]--><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="redux" tabindex="-1"><a class="header-anchor" href="#redux" aria-hidden="true">#</a> redux</h1><h2 id="概念" tabindex="-1"><a class="header-anchor" href="#概念" aria-hidden="true">#</a> 概念</h2><p>Redux 是一个使用叫做“action”的事件来管理和更新应用状态的模式和工具库。它以集中式 <code>Store（centralized store）</code>的方式对整个应用中使用的状态进行集中管理，其规则确保状态只能以可预测的方式更新。</p><p>Redux 提供的模式和工具使您更容易理解应用程序中的状态何时、何地、为什么以及如何更新，以及当这些更改发生时您的应用程序逻辑将如何表现</p><h3 id="state-管理" tabindex="-1"><a class="header-anchor" href="#state-管理" aria-hidden="true">#</a> State 管理</h3><p>假设一个包含以下内容的应用程序</p><ul><li>state：驱动应用的真实数据源头</li><li>view：基于当前状态的 UI 声明性描述</li><li>actions：根据用户输入在应用程序中发生的事件，并触发状态更新</li></ul><p>存在以下单向数据流（one-way data flow）</p><ul><li>用 state 来描述应用程序在特定时间点的状况</li><li>基于 state 来渲染出 View</li><li>当发生某些事情时（例如用户单击按钮），state 会根据发生的事情进行更新，生成新的 state</li><li>基于新的 state 重新渲染 View</li></ul><p><img src="http://cn.redux.js.org/assets/images/one-way-data-flow-04fe46332c1ccb3497ecb04b94e55b97.png" alt="单向数据流"></p><p>然而，当我们有多个组件需要共享和使用相同 <code>state</code> 时会变得很复杂，解决这个问题的一种方法是从组件中提取共享 <code>state</code>，并将其放入组件树之外的一个集中位置。这样，我们的组件树就变成了一个大<code>view</code>，任何组件都可以访问 <code>state</code> 或触发 <code>action</code>，无论它们在树中的哪个位置！</p><p><strong>这就是 Redux 背后的基本思想：应用中使用集中式的全局状态来管理，并明确更新状态的模式，以便让代码具有可预测性。</strong></p><h3 id="术语" tabindex="-1"><a class="header-anchor" href="#术语" aria-hidden="true">#</a> 术语</h3><h4 id="action" tabindex="-1"><a class="header-anchor" href="#action" aria-hidden="true">#</a> Action</h4><p><code>action</code> 是一个具有 <code>type</code> 字段的普通 <code>JavaScript</code> 对象。你可以将 <code>action</code> 视为描述应用程序中发生了什么的事件</p><p><code>action</code> 的 <code>type</code> 字段是一个字符串，给这个 <code>action</code> 一个描述性的名字，通常把那个类型的字符串写成“域/事件名称”，其中第一部分是这个 <code>action</code> 所属的特征或类别，第二部分是发生的具体事情</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> addTodoAction <span class="token operator">=</span> <span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">&quot;todos/todoAdded&quot;</span><span class="token punctuation">,</span>
  payload<span class="token operator">:</span> <span class="token string">&quot;Buy milk&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="action-creator" tabindex="-1"><a class="header-anchor" href="#action-creator" aria-hidden="true">#</a> action creator</h4><p><code>action creator</code> 是一个创建并返回一个 <code>action</code> 对象的函数。它的作用是让你不必每次都手动编写 <code>action</code> 对象</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">addTodo</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">text</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">&quot;todos/todoAdded&quot;</span><span class="token punctuation">,</span>
    payload<span class="token operator">:</span> text<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="reducer" tabindex="-1"><a class="header-anchor" href="#reducer" aria-hidden="true">#</a> Reducer</h4><p><code>reducer</code> 是一个函数，接收当前的 <code>state</code> 和一个 <code>action</code> 对象，必要时决定如何更新状态，并返回新状态。函数签名是：<code>(state, action) =&gt; newState</code>。</p><p>你可以将 <code>reducer</code> 视为一个事件监听器，它根据接收到的 action（事件）类型处理事件。</p><p>每当 dispatch 一个 <code>action</code> 后，<code>store</code> 就会调用 <code>root reducer</code></p><p>Reducer 必需符合以下规则：</p><ul><li>仅使用 state 和 action 参数计算新的状态值</li><li>禁止直接修改 state。必须通过复制现有的 state 并对复制的值进行更改的方式来做 不可变更新（immutable updates）。</li><li>禁止任何异步逻辑、依赖随机值或导致其他“副作用”的代码</li><li>稍后我们将更多地讨论 reducer 的规则，包括为什么它们很重要以及如何正确地遵循它们。</li></ul><p>reducer 函数内部的逻辑通常遵循以下步骤：</p><ul><li>检查 reducer 是否关心这个 action。如果是，则复制 state，使用新值更新 state 副本，然后返回新 state</li><li>否则，返回原来的 state 不变</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> initialState <span class="token operator">=</span> <span class="token punctuation">{</span> value<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">counterReducer</span><span class="token punctuation">(</span><span class="token parameter">state <span class="token operator">=</span> initialState<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 检查 reducer 是否关心这个 action</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">&quot;counter/increment&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果是，复制 `state`</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      <span class="token operator">...</span>state<span class="token punctuation">,</span>
      <span class="token comment">// 使用新值更新 state 副本</span>
      value<span class="token operator">:</span> state<span class="token punctuation">.</span>value <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 返回原来的 state 不变</span>
  <span class="token keyword">return</span> state<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="redux-三大原则" tabindex="-1"><a class="header-anchor" href="#redux-三大原则" aria-hidden="true">#</a> redux 三大原则</h3><ul><li>单一数据源</li></ul><p>整个应用的 state 被储存在一棵 object tree 中，并且这个 object tree 只存在于唯一一个 store 中。</p><ul><li>state 是只读的</li></ul><p>唯一改变 state 的方法就是触发 action，action 是一个用于描述已发生事件的普通对象。</p><ul><li><p>使用纯函数来执行修改</p><ul><li>为了描述 action 如何改变 state tree ，你需要编写 reducers。</li><li>Reducer 只是一些纯函数，它接收先前的 state 和 action，并返回新的 state。刚开始你可以只有一个 reducer，随着应用变大，你可以把它拆成多个小的 reducers，分别独立地操作 state tree 的不同部分，因为 reducer 只是函数，你可以控制它们被调用的顺序，传入附加数据，甚至编写可复用的 reducer 来处理一些通用任务，如分页器</li></ul></li></ul><h3 id="redux-数据流" tabindex="-1"><a class="header-anchor" href="#redux-数据流" aria-hidden="true">#</a> Redux 数据流</h3><p>在上面我们谈到了“单向数据流”，对于 <code>Redux</code>，我们可以将这些步骤分解为更详细的内容</p><ul><li>初始启动： <ul><li>使用最顶层的 root reducer 函数创建 Redux store</li><li>store 调用一次 root reducer，并将返回值保存为它的初始 state</li><li>当 UI 首次渲染时，UI 组件访问 Redux store 的当前 state，并使用该数据来决定要呈现的内容。同时监听 store 的更新，以便他们可以知道 state 是否已更改。</li></ul></li><li>更新环节： <ul><li>应用程序中发生了某些事情，例如用户单击按钮</li><li>dispatch 一个 action 到 Redux store，例如 dispatch({type: &#39;counter/increment&#39;})</li><li>store 用之前的 state 和当前的 action 再次运行 reducer 函数，并将返回值保存为新的 state</li><li>store 通知所有订阅过的 UI，通知它们 store 发生更新</li><li>每个订阅过 store 数据的 UI 组件都会检查它们需要的 state 部分是否被更新。</li><li>发现数据被更新的每个组件都强制使用新数据重新渲染，紧接着更新网页</li></ul></li></ul><h3 id="什么时候使用-redux" tabindex="-1"><a class="header-anchor" href="#什么时候使用-redux" aria-hidden="true">#</a> 什么时候使用 redux</h3><p>Redux 可帮助处理共享状态的管理，但有更多的概念需要学习，还有更多的代码需要编写，并要求遵循某些限制</p><p>Redux 在以下情况下更有用：</p><ul><li>在应用的大量地方，都存在大量的状态</li><li>应用状态会随着时间的推移而频繁更新</li><li>更新该状态的逻辑可能很复杂</li><li>中型和大型代码量的应用，很多人协同开发</li></ul><h3 id="注意点" tabindex="-1"><a class="header-anchor" href="#注意点" aria-hidden="true">#</a> 注意点</h3><ul><li><p>诸如唯一的 ID 和一些随机值应该放在 action 里，而不是在 reducer 中去计算。 <strong>Reducer 中永远不应该计算随机值</strong>，因为这会使结果不可预测。</p></li><li><p>Redux action 和 state 应该只能包含普通的 JS 值，如对象、数组和基本类型。<strong>不要将类实例、函数或其他不可序列化的值放入 Redux！</strong>。</p></li><li><p>action 对象只包含描述发生的事情所需的最少信息，并在 reducer 中进行状态更新计算，这也意味着 reducer 中可以包含计算新状态所需的尽可能多的逻辑。</p></li><li><p>组件应该根据其渲染所需，从 Redux Store 中读取最小量的数据</p></li></ul><h2 id="示例" tabindex="-1"><a class="header-anchor" href="#示例" aria-hidden="true">#</a> 示例</h2><h3 id="redux-1" tabindex="-1"><a class="header-anchor" href="#redux-1" aria-hidden="true">#</a> redux</h3><p>应用的整体全局状态以对象树的方式存放于单个 <strong>store</strong>。</p><p>唯一改变状态树（state tree）的方法是创建 <strong>action</strong></p><p><strong>reducer</strong> 函数根据旧 state 和 action 来计算新 state</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;redux&quot;</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * 这是一个 reducer，形式为 (state, action) =&gt; state 的纯函数。
 * 描述了 action 如何把 state 转变成下一个 state。
 *
 * state 的形式取决于你，可以是基本类型、数组、对象、
 * 甚至是 Immutable.js 生成的数据结构。惟一的要点是
 * 当 state 变化时需要返回全新的对象，而不是修改传入的参数。
 *
 * 下面例子使用 `switch` 语句和字符串来做判断，但你可以写帮助类(helper)
 * 根据不同的约定（如方法映射）来判断，只要适用你的项目即可。
 */</span>
<span class="token keyword">function</span> <span class="token function">counterReducer</span><span class="token punctuation">(</span><span class="token parameter">state <span class="token operator">=</span> <span class="token punctuation">{</span> value<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">&quot;counter/incremented&quot;</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> value<span class="token operator">:</span> state<span class="token punctuation">.</span>value <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">&quot;counter/decremented&quot;</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span> value<span class="token operator">:</span> state<span class="token punctuation">.</span>value <span class="token operator">-</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">return</span> state<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 创建 Redux store 来存放应用的状态。</span>
<span class="token comment">// API 是 { subscribe, dispatch, getState }。</span>
<span class="token keyword">let</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span>counterReducer<span class="token punctuation">)</span><span class="token punctuation">;</span>

store<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 改变内部 state 惟一方法是 dispatch 一个 action。</span>
<span class="token comment">// action 可以被序列化，用日记记录和储存下来，后期还可以以回放的方式执行</span>
store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&quot;counter/incremented&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// {value: 1}</span>
store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&quot;counter/incremented&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// {value: 2}</span>
store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&quot;counter/decremented&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// {value: 1}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><h3 id="redux-toolkit" tabindex="-1"><a class="header-anchor" href="#redux-toolkit" aria-hidden="true">#</a> Redux Toolkit</h3><p><code>Redux Toolkit</code> 是官方推荐的编写 <code>Redux</code> 逻辑的方法。它包含了 <code>Redux</code> 核心，并包含对于构建 <code>Redux</code> 应用必不可少的软件包和功能。<code>Redux Toolkit</code> 建立在最佳实践中，简化了大多数 Redux 任务，防止了常见错误，并使编写 <code>Redux</code> 应用程序更加容易。</p><div class="language-jsx ext-jsx line-numbers-mode"><pre class="language-jsx"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createSlice<span class="token punctuation">,</span> configureStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@reduxjs/toolkit&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> counterSlice <span class="token operator">=</span> <span class="token function">createSlice</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">&quot;counter&quot;</span><span class="token punctuation">,</span>
  initialState<span class="token operator">:</span> <span class="token punctuation">{</span>
    value<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  reducers<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">incremented</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// Redux工具包允许我们在Reducer中编写&quot;mutating&quot; 逻辑。它</span>
      <span class="token comment">//实际上不会改变状态，因为它使用Immer库，</span>
      <span class="token comment">//它检测到“草稿状态”的更改并生成全新的</span>
      <span class="token comment">//基于这些更改的不变状态</span>
      state<span class="token punctuation">.</span>value <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">decremented</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      state<span class="token punctuation">.</span>value <span class="token operator">-=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> incremented<span class="token punctuation">,</span> decremented <span class="token punctuation">}</span> <span class="token operator">=</span> counterSlice<span class="token punctuation">.</span>actions<span class="token punctuation">;</span>

<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">configureStore</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  reducer<span class="token operator">:</span> counterSlice<span class="token punctuation">.</span>reducer<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Can still subscribe to the store</span>
store<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 仍将操作对象传递给“dispatch”，但它们是我们创建的</span>
store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token function">incremented</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// {value: 1}</span>
store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token function">incremented</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// {value: 2}</span>
store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token function">decremented</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// {value: 1}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><h2 id="使用" tabindex="-1"><a class="header-anchor" href="#使用" aria-hidden="true">#</a> 使用</h2><h3 id="使用-useselector-提取数据" tabindex="-1"><a class="header-anchor" href="#使用-useselector-提取数据" aria-hidden="true">#</a> 使用 useSelector 提取数据</h3><p><code>useSelector</code> 这个 hooks 让我们的组件从 Redux 的 store 状态树中提取它需要的任何数据。</p><p>我们的组件不能直接与 Redux store 对话，因为组件文件中不能引入 store。但是，<code>useSelector</code> 负责为我们在幕后与 Redux store 对话。 如果我们传入一个 selector 函数，它会为我们调用 <code>someSelector(store.getState())</code>，并返回结果。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// counterSlice.js</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">selectCount</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> state<span class="token punctuation">.</span>counter<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">selectUserById</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> userId</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
  state<span class="token punctuation">.</span>users<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> user<span class="token punctuation">.</span>id <span class="token operator">===</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token function">useSelector</span><span class="token punctuation">(</span>selectCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token function">useSelector</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">selectUserById</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>每当一个 action 被 dispatch 并且 Redux store 被更新时，<code>useSelector</code> 将重新运行我们的选择器函数。<strong>如果选择器返回的值与上次不同，<code>useSelector</code> 将确保我们的组件使用新值重新渲染。</strong></p><p>任何需要从 Redux store 读取数据的组件都可以使用 <code>useSelector</code> 钩子，并提取它需要的特定数据片段。此外，<strong>许多组件可以同时访问 Redux store 中的相同数据。</strong></p><h3 id="使用-usedispatch-来-dispatch-action" tabindex="-1"><a class="header-anchor" href="#使用-usedispatch-来-dispatch-action" aria-hidden="true">#</a> 使用 useDispatch 来 dispatch action</h3><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> dispatch <span class="token operator">=</span> <span class="token function">useDispatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token operator">&lt;</span>button
  className<span class="token operator">=</span><span class="token punctuation">{</span>styles<span class="token punctuation">.</span>button<span class="token punctuation">}</span>
  aria<span class="token operator">-</span>label<span class="token operator">=</span><span class="token string">&quot;Increment value&quot;</span>
  onClick<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
<span class="token operator">&gt;</span>
  <span class="token operator">+</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="在-reducer-定义一个-prepare-函数" tabindex="-1"><a class="header-anchor" href="#在-reducer-定义一个-prepare-函数" aria-hidden="true">#</a> 在 reducer 定义一个 prepare 函数</h3><p>我们 dispatch action 时，如果准备参数的逻辑很复杂，createSlice 允许我们在编写 reducer 时定义一个 prepare 函数。</p><p>prepare 函数可以接受多个参数，生成诸如唯一 ID 之类的随机值，并运行需要的任何其他同步逻辑来决定哪些值进入 action 对象。</p><p>然后它应该返回一个包含 <code>payload</code> 字段的对象。（返回对象还可能包含一个 <code>meta</code> 字段，可用于向 action 添加额外的描述性值，以及一个 <code>error</code> 字段，该字段应该是一个布尔值，指示此 action 是否表示某种错误。）</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> postsSlice <span class="token operator">=</span> <span class="token function">createSlice</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">&quot;posts&quot;</span><span class="token punctuation">,</span>
  initialState<span class="token punctuation">,</span>
  reducers<span class="token operator">:</span> <span class="token punctuation">{</span>
    postAdded<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">reducer</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        state<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function">prepare</span><span class="token punctuation">(</span><span class="token parameter">title<span class="token punctuation">,</span> content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
          payload<span class="token operator">:</span> <span class="token punctuation">{</span>
            id<span class="token operator">:</span> <span class="token function">nanoid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            title<span class="token punctuation">,</span>
            content<span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// other reducers here</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>现在我们的组件不必担心 payload 对象是什么样子 - action creator 将负责以正确的方式将它组合在一起。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">onSavePostClicked</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token function">postAdded</span><span class="token punctuation">(</span>title<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="用-thunk-编写异步逻辑" tabindex="-1"><a class="header-anchor" href="#用-thunk-编写异步逻辑" aria-hidden="true">#</a> 用 Thunk 编写异步逻辑</h3><p><code>thunk</code> 是一种特定类型的 <code>Redux</code> 函数，可以包含异步逻辑。</p><p><strong>使用 <code>thunk</code> 需要在创建时将 <code>redux-thunk</code> middleware（一种 Redux 插件）添加到 Redux store 中。<code>Redux Toolkit</code> 的 <code>configureStore</code> 函数已经自动为我们配置好了</strong></p><h4 id="使用-middleware-中间件处理异步逻辑" tabindex="-1"><a class="header-anchor" href="#使用-middleware-中间件处理异步逻辑" aria-hidden="true">#</a> 使用 Middleware 中间件处理异步逻辑</h4><p><code>Redux store</code> 对异步逻辑一无所知。它只知道如何同步 dispatch action，通过调用 root reducer 函数更新状态，并通知 UI 某些事情发生了变化。任何异步都必须发生在 store 之外。</p><p>Redux 中间件 可以使异步逻辑与 store 交互，它们扩展了 store，并允许：</p><ul><li><p>dispatch action 时执行额外的逻辑（例如打印 action 的日志和状态）</p></li><li><p>暂停、修改、延迟、替换或停止 dispatch 的 action</p></li><li><p>编写可以访问 dispatch 和 getState 的额外代码</p></li><li><p>教 dispatch 如何接受除普通 action 对象之外的其他值，例如函数和 promise，通过拦截它们并 dispatch 实际 action 对象来代替</p></li></ul><p><strong>使用中间件的最常见原因是允许不同类型的异步逻辑与 store 交互。</strong> 这允许您编写可以 dispatch action 和检查 store 状态的代码，同时使该逻辑与您的 UI 分开。</p><p>Redux 有多种异步中间件，<code>Redux Toolkit</code> 的 <code>configureStore</code> 功能默认自动设置 <code>thunk</code> 中间件</p><h4 id="thunk-函数" tabindex="-1"><a class="header-anchor" href="#thunk-函数" aria-hidden="true">#</a> Thunk 函数</h4><p>将 thunk 中间件添加到 Redux store 后，它允许将 thunk 函数 直接传递给 store.dispatch。<strong>调用 thunk 函数时总是将 <code>(dispatch, getState)</code> 作为它的参数</strong>，你可以根据需要在 thunk 中使用它们。</p><p>为了与 dispatch 普通 action 对象保持一致，我们通常将它们写为 <code>thunk action creators</code>，它返回 thunk 函数。这些 <code>action creator</code> 可以接受可以在 thunk 中使用的参数。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">incrementAsync</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">amount</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter">dispatch</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token function">incrementByAmount</span><span class="token punctuation">(</span>amount<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>可以像使用普通 Redux action creator 一样使用它们</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code>store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token function">incrementAsync</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br></div></div><p>当您需要进行 AJAX 调用以从服务器获取数据时，可以将该调用放入 <code>thunk</code> 中</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 外部的 thunk creator 函数</span>
<span class="token keyword">const</span> <span class="token function-variable function">fetchUserById</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">userId</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 内部的 thunk 函数</span>
  <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">dispatch<span class="token punctuation">,</span> getState</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// thunk 内发起异步数据请求</span>
      <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> userAPI<span class="token punctuation">.</span><span class="token function">fetchById</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 但数据响应完成后 dispatch 一个 action</span>
      <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token function">userLoaded</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果过程出错，在这里处理</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>Thunk 通常写在 <code>createSlice</code> 文件中。<code>createSlice</code> 本身对定义 thunk 没有任何特殊支持，因此您应该将它们作为单独的函数编写在同一个切片文件中。这样，他们就可以访问该<code>createSlice</code>的普通 <code>action creator</code>，并且很容易找到 thunk 的位置。</p><h4 id="编写异步-thunks" tabindex="-1"><a class="header-anchor" href="#编写异步-thunks" aria-hidden="true">#</a> 编写异步 Thunks</h4><p><code>Redux Toolkit</code> 提供了一个 <code>createAsyncThunk</code> API 自动 dispatch 接口请求的<code>start</code>/<code>success</code>/<code>failure</code> action</p><p><code>createAsyncThunk</code> 接收 2 个参数:</p><ul><li>将用作生成的 action 类型的前缀的字符串</li><li>一个“payload creator”回调函数，它应该返回一个包含一些数据的 Promise，或者一个被拒绝的带有错误的 Promise</li></ul><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createAsyncThunk <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@reduxjs/toolkit&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> client <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../../api/client&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> fetchPosts <span class="token operator">=</span> <span class="token function">createAsyncThunk</span><span class="token punctuation">(</span><span class="token string">&quot;posts/fetchPosts&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/fakeApi/posts&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> response<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>在组件中 dispatch thunk</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useEffect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> useDispatch <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react-redux&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> fetchPosts <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./postsSlice&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">PostsList</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> dispatch <span class="token operator">=</span> <span class="token function">useDispatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>postStatus <span class="token operator">===</span> <span class="token string">&quot;idle&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token function">fetchPosts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>postStatus<span class="token punctuation">,</span> dispatch<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>1、当调用 <code>dispatch(fetchPosts())</code> 的时候，<code>fetchPosts</code> 这个 thunk 会首先 dispatch 一个 action 类型为<code>posts/fetchPosts/pending</code></p><p>2、一旦 Promise 成功，<code>fetchPosts</code> thunk 会接受我们从回调中返回的 <code>response.data</code> 数组，并 dispatch 一个 action，action 的 payload 为 posts 数组，action 的 类型为 <code>posts/fetchPosts/fulfilled</code>。</p><p>我们需要在我们的 reducer 中处理这两个 action。这需要更深入地了解我们一直在使用的 <code>createSlice</code> API。</p><p>有时切片的 reducer 需要响应 没有 定义到该切片的 reducers 字段中的 action。这个时候就需要使用 slice 中的 <code>extraReducers</code> 字段。<code>extraReducers</code> 选项是一个接收名为 <code>builder</code> 的参数的函数。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> initialState <span class="token operator">=</span> <span class="token punctuation">{</span>
  posts<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  status<span class="token operator">:</span> <span class="token string">&quot;idle&quot;</span><span class="token punctuation">,</span>
  error<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> fetchPosts <span class="token operator">=</span> <span class="token function">createAsyncThunk</span><span class="token punctuation">(</span><span class="token string">&quot;posts/fetchPosts&quot;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/fakeApi/posts&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> response<span class="token punctuation">.</span>data<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> postsSlice <span class="token operator">=</span> <span class="token function">createSlice</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">&quot;posts&quot;</span><span class="token punctuation">,</span>
  initialState<span class="token punctuation">,</span>
  reducers<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// omit existing reducers here</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">extraReducers</span><span class="token punctuation">(</span><span class="token parameter">builder</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    builder
      <span class="token punctuation">.</span><span class="token function">addCase</span><span class="token punctuation">(</span>fetchPosts<span class="token punctuation">.</span>pending<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        state<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">&quot;loading&quot;</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">addCase</span><span class="token punctuation">(</span>fetchPosts<span class="token punctuation">.</span>fulfilled<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        state<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">&quot;succeeded&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">// Add any fetched posts to the array</span>
        state<span class="token punctuation">.</span>posts <span class="token operator">=</span> state<span class="token punctuation">.</span>posts<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">addCase</span><span class="token punctuation">(</span>fetchPosts<span class="token punctuation">.</span>rejected<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        state<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">&quot;failed&quot;</span><span class="token punctuation">;</span>
        state<span class="token punctuation">.</span>error <span class="token operator">=</span> action<span class="token punctuation">.</span>error<span class="token punctuation">.</span>message<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p><code>Redux Toolkit</code> 向返回的 Promise 添加了一个 <code>.unwrap()</code> 函数，它将返回一个新的 Promise，这个 Promise 在 fulfilled 状态时返回实际的 action.payload 值，或者在 “rejected” 状态下抛出错误。这让我们可以使用正常的 try/catch 逻辑处理组件中的成功和失败。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{</span> useState <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> addNewPost <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./postsSlice&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">AddPostForm</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>addRequestStatus<span class="token punctuation">,</span> setAddRequestStatus<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">useState</span><span class="token punctuation">(</span><span class="token string">&quot;idle&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">onSavePostClicked</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>canSave<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token function">setAddRequestStatus</span><span class="token punctuation">(</span><span class="token string">&quot;pending&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token function">addNewPost</span><span class="token punctuation">(</span><span class="token punctuation">{</span> title<span class="token punctuation">,</span> content<span class="token punctuation">,</span> user<span class="token operator">:</span> userId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to save the post: &quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token function">setAddRequestStatus</span><span class="token punctuation">(</span><span class="token string">&quot;idle&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h4 id="thunk-参数" tabindex="-1"><a class="header-anchor" href="#thunk-参数" aria-hidden="true">#</a> Thunk 参数</h4><p><code>createAsyncThunk</code> 只能传递一个参数，无论我们传入的是什么，它都将成为 payload creation 回调的第一个参数。</p><p>payload creator 的第二个参数是一个&#39; thunkAPI &#39;对象，包含几个有用的函数和信息：</p><ul><li><p>dispatch 和 getState：dispatch 和 getState 方法由 Redux store 提供。您可以在 thunk 中使用这些来发起 action，或者从最新的 Redux store 中获取 state （例如在发起 另一个 action 后获取更新后的值）。</p></li><li><p>extra：当创建 store 时，用于传递给 thunk 中间件的“额外参数”。</p></li><li><p>requestId：该 thunk 调用的唯一随机 ID ，用于跟踪单个请求的状态。</p></li><li><p>signal：一个 <code>AbortController.signal</code> 函数，可用于取消正在进行的请求。</p></li><li><p>rejectWithValue：一个用于当 thunk 收到一个错误时帮助自定义 rejected action 内容的工具。</p></li></ul><blockquote><p>手写 thunk 而不是使用 createAsyncThunk，则 thunk 函数将获取 (dispatch, getState) 作为单独的参数</p></blockquote><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">const</span> fetchNotifications <span class="token operator">=</span> <span class="token function">createAsyncThunk</span><span class="token punctuation">(</span>
  <span class="token string">&quot;notifications/fetchNotifications&quot;</span><span class="token punctuation">,</span>
  <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> <span class="token punctuation">{</span> getState <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> since <span class="token operator">=</span> <span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/fakeApi/notifications?since=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>since<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> response<span class="token punctuation">.</span>notifications<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="记忆化的-selector-函数" tabindex="-1"><a class="header-anchor" href="#记忆化的-selector-函数" aria-hidden="true">#</a> 记忆化的 Selector 函数</h3><p>每次渲染时 <code>useSelector</code> 如果返回一个新的引用值，它会强制组件重新渲染。例如</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> postsForUser <span class="token operator">=</span> <span class="token function">useSelector</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> allPosts <span class="token operator">=</span> <span class="token function">selectAllPosts</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> allPosts<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">post</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> post<span class="token punctuation">.</span>user <span class="token operator">===</span> userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><code>useSelector</code> 钩子中调用了 <code>filter()</code>，以便只返回属于该用户的帖子列表，这意味着 <code>useSelector</code> 总会 返回一个新的数组，所以 每次 执行以上操作我们的组件都将重新渲染，即使返回的数据并没有发生改变！</p><p><strong>Reselect 是一个创建记忆化 selector 函数的库</strong>，并且是专门设计用来与 Redux 一起使用的。它有一个 <code>createSelector</code> 函数，可以创建记忆化的 selector，只有在输入发生变化时才会重新计算结果。</p><p><code>Redux Toolkit</code> 导出了 <code>createSelector</code> 函数 ，因此我们可以直接使用它。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>
  createSlice<span class="token punctuation">,</span>
  createAsyncThunk<span class="token punctuation">,</span>
  createSelector<span class="token punctuation">,</span>
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@reduxjs/toolkit&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// omit slice logic</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">selectAllPosts</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> state<span class="token punctuation">.</span>posts<span class="token punctuation">.</span>posts<span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">selectPostById</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> postId</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
  state<span class="token punctuation">.</span>posts<span class="token punctuation">.</span>posts<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">post</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> post<span class="token punctuation">.</span>id <span class="token operator">===</span> postId<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> selectPostsByUser <span class="token operator">=</span> <span class="token function">createSelector</span><span class="token punctuation">(</span>
  <span class="token punctuation">[</span>selectAllPosts<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> userId</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> userId<span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">posts<span class="token punctuation">,</span> userId</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> posts<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">post</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> post<span class="token punctuation">.</span>user <span class="token operator">===</span> userId<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p><code>createSelector</code> 将一个或多个“输入 selector ”函数作为参数，外加一个“输出 selector ”函数。 当我们调用 <code>selectPostsByUser(state, userId)</code> 时，<code>createSelector</code> 会将所有参数传递给每个输入 selector 。无论这些输入 selector 返回什么，都将成为输出 selector 的参数。</p><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: gkckx37@163.com">goodboy-yes</span><!----><!--]--><!--]--></span></div></footer><nav class="page-nav"><p class="inner"><span class="prev"><a href="/my-notes/react/code-standard.html" class="nav-link" aria-label="代码规范"><!--[--><!--]--> 代码规范 <!--[--><!--]--></a></span><span class="next"><a href="/my-notes/react/dva.html" class="nav-link" aria-label="dva"><!--[--><!--]--> dva <!--[--><!--]--></a></span></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/my-notes/assets/app.93ab8767.js" defer></script>
  </body>
</html>
